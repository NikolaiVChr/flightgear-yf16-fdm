<?xml version="1.0"?>

<flight_control name="FC">

    <channel execrate="1" name="Leading edge flaps">

        <fcs_function name="fcs/fly-by-wire/lef/input-factor">
            <function>
                <value>1.38</value>
            </function>
        </fcs_function>

        <lead_lag_filter name="fcs/fly-by-wire/lef/lead-lag">
          <input> fcs/fly-by-wire/lef/input-factor </input>
          <c1> 2 </c1>
          <c2> 7.25 </c2>
          <c3> 1 </c3>
          <c4> 7.25 </c4>
        </lead_lag_filter>

        <pure_gain name="fcs/fly-by-wire/lef/alpha-gain">
            <input>fcs/fly-by-wire/lef/lead-lag</input>
            <gain>aero/alpha-deg</gain>
        </pure_gain>

        <fcs_function name="fcs/fly-by-wire/lef/cmd-pos">
            <function>
                <difference>
                    <p>fcs/fly-by-wire/lef/alpha-gain</p>
                    <sum>
                        <product>
                            <value>9.05</value>
                            <quotient>
                                <p>aero/qbar-psf</p><!-- dynamic pressure -->
                                <p>atmosphere/P-psf</p><!-- static pressure -->
                            </quotient>
                        </product>
                        <v>1.45</v>
                    </sum>
                </difference>
            </function>
        </fcs_function>

        <lag_filter name="fcs/fly-by-wire/lef/pos-direct">
            <input> fcs/fly-by-wire/lef/cmd-pos </input>
            <c1> 0.136 </c1>
        </lag_filter>

        <kinematic name="fcs/lef-pos-deg">
            <input>fcs/fly-by-wire/lef/pos-direct</input>
            <noscale/>
            <traverse>
                <setting>
                    <position>0</position>
                    <time>0.0</time>
                </setting>
                <setting>
                    <position>25</position>
                    <time>1</time><!-- 25 degs per second -->
                </setting>
            </traverse>
            <clipto>
                <min>0</min>
                <max>25</max>
            </clipto>
        </kinematic>

        <pure_gain name="fcs/lef-pos-rad">
            <input>fcs/lef-pos-deg</input>
            <gain>0.017453</gain>
        </pure_gain>

        <aerosurface_scale name="fcs/lef-pos-norm">
            <input>fcs/lef-pos-deg</input>
            <zero_centered> true </zero_centered>
            <domain>
                <min> 0 </min>
                <max> 25 </max>
            </domain>
            <range>
                <min>0</min>                
                <max>1</max>
            </range>
        </aerosurface_scale>

        <fcs_function name="fcs/lef-pos-r-norm">
            <function>
                <difference>
                    <v>1</v>
                    <p>fcs/lef-pos-norm</p>
                </difference>
            </function>
        </fcs_function>

    </channel>

    <channel execrate="1" name="Pitch A">

        <fcs_function name="fcs/fly-by-wire/pitch/stick-force-N">
            <function>
                <table>
                    <independentVar lookup="row">fcs/elevator-cmd-norm</independentVar>
                    <tableData>
                       -1  180
                        0    0
                        1  -80
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <lag_filter name="fcs/fly-by-wire/pitch/stick-force-N-lagged">
            <input> fcs/fly-by-wire/pitch/stick-force-N </input>
            <c1> 60 </c1>
        </lag_filter>

        <fcs_function name="fcs/fly-by-wire/pitch/command-g">
            <function>
                <table>
                    <independentVar lookup="row">fcs/fly-by-wire/pitch/stick-force-N-lagged</independentVar>
                    <tableData>
                        -80  -4.0
                        -35  -0.5
                         -8   0.0
                          8   0.0
                         35   0.5 
                        180  11.0
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <aerosurface_scale name="fcs/fly-by-wire/pitch/trim-scaled">
            <input>fcs/pitch-trim-cmd-norm</input>
            <zero_centered> true </zero_centered>
            <domain>
                <min> -1.0 </min>
                <max>  1.0 </max>
            </domain>
            <range>
                <min> -2.4 </min>
                <max>  2.4 </max>
            </range>
        </aerosurface_scale>

        <summer name="fcs/fly-by-wire/pitch/command-sum">
            <input>fcs/fly-by-wire/pitch/trim-scaled</input>
            <input>fcs/fly-by-wire/pitch/command-g</input>
        </summer>

        <fcs_function name="fcs/fly-by-wire/pitch/negative-g-limit">
            <function>
                <table>
                    <independentVar lookup="row">aero/qbar-psf</independentVar>
                    <tableData>
                        0.0      -1
                        31.32815 -1
                        187.9689 -4
                        208.8543 -4
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <summer name="fcs/fly-by-wire/pitch/g-limit">
            <description>This deviates slightly from the diagram, but I think this is how its intended.</description>
            <input>fcs/fly-by-wire/pitch/command-sum</input>
            <clipto>
                <min>fcs/fly-by-wire/pitch/negative-g-limit</min>
                <max>8.0</max>
            </clipto>
        </summer>

        <lag_filter name="fcs/fly-by-wire/pitch/command-sum-limit-lagged">
            <input> fcs/fly-by-wire/pitch/g-limit </input>
            <c1> 8.3 </c1>
        </lag_filter>

        <summer name="fcs/fly-by-wire/pitch/alpha-indicated-clamp">
            <input>aero/alpha-deg</input><!-- should really be indicated -->
            <clipto>
                <min>-5</min>
                <max>30</max>
            </clipto>
        </summer>

        <lag_filter name="fcs/fly-by-wire/pitch/alpha-indicated-lagged">
            <input> fcs/fly-by-wire/pitch/alpha-indicated-clamp </input>
            <c1> 10 </c1>
        </lag_filter>

        <fcs_function name="fcs/fly-by-wire/pitch/alpha-indicated-sum">
            <function>
                <sum>
                    <property> fcs/fly-by-wire/pitch/alpha-indicated-lagged </property>
                    <value> -20.4 </value><!-- this could be positive, the minus on diagram could be a random line. YF suggest negative. -->
                    <property> fcs/fly-by-wire/pitch/pitch-rate-gain </property>
                </sum>
            </function>
        </fcs_function>

        <pure_gain name="fcs/fly-by-wire/pitch/alpha-indicated-gain">
            <input>fcs/fly-by-wire/pitch/alpha-indicated-sum</input>
            <gain> 1 </gain>
            <clipto>
                <min> 0 </min>
                <max>10000</max>
            </clipto>
        </pure_gain>

        <summer name="fcs/fly-by-wire/pitch/command-sum-limit-alpha">
            <input> -fcs/fly-by-wire/pitch/command-sum-limit-lagged </input>
            <input> fcs/fly-by-wire/pitch/alpha-indicated-gain </input>
        </summer>

        <summer name="fcs/fly-by-wire/pitch/command-sum-limit-alpha-pitch">
            <input> fcs/fly-by-wire/pitch/command-sum-limit-alpha </input>
            <input> fcs/fly-by-wire/pitch/pitch-rate-lead </input>
        </summer>

        <pure_gain name="fcs/fly-by-wire/pitch/command-sum-limit-alpha-pitch-gain">
            <input>fcs/fly-by-wire/pitch/command-sum-limit-alpha-pitch</input>
            <gain> 1.5 </gain>
        </pure_gain>

        <scheduled_gain name="fcs/fly-by-wire/pitch/pitch-loop-gain">
            <input>fcs/fly-by-wire/pitch/command-sum-limit-alpha-pitch-gain</input>
            <table>
                <independentVar lookup="row">aero/qbar-psf</independentVar>
                <tableData>
                    0.0       1.0
                    250.6252  1.0
                    898.0737  0.4
                    1169.584  0.4
                </tableData>
            </table>
        </scheduled_gain>

        <summer name="fcs/fly-by-wire/pitch/pitch-loop-gain-sum">
            <input> fcs/fly-by-wire/pitch/pitch-loop-gain </input>
            <input> -fcs/fly-by-wire/pitch/pitch-loop-gain-feedback-gain </input>
        </summer>

        <integrator name="fcs/fly-by-wire/pitch/pitch-loop-gain-sum-int">
            <input> fcs/fly-by-wire/pitch/pitch-loop-gain-sum </input>
            <trigger> gear/gear-pos-norm </trigger>
            <c1> 5 </c1>
            <clipto>
                <min> -25 </min>
                <max>  25 </max>
            </clipto>
        </integrator>

        <summer name="fcs/fly-by-wire/pitch/pitch-loop-gain-sum-int-sum">
            <input> fcs/fly-by-wire/pitch/pitch-loop-gain-sum-int </input>
            <input> fcs/fly-by-wire/pitch/pitch-loop-gain </input>
        </summer>

        <summer name="fcs/fly-by-wire/pitch/pitch-loop-gain-sum-int-sum-sum">
            <input> fcs/fly-by-wire/pitch/pitch-loop-gain-sum-int-sum </input>
            <input> fcs/fly-by-wire/pitch/alpha-feedback </input>
        </summer>
        
        <fcs_function name="fcs/fly-by-wire/pitch/pitch-loop-gain-feedback-deadzone-neg">
            <function>
                <difference>
                    <property> fcs/fly-by-wire/pitch/pitch-loop-gain-sum-int-sum-sum </property>
                    <value> -25 </value>
                </difference>
            </function>
        </fcs_function>

        <fcs_function name="fcs/fly-by-wire/pitch/pitch-loop-gain-feedback-deadzone-pos">
            <function>
                <difference>
                    <property> fcs/fly-by-wire/pitch/pitch-loop-gain-sum-int-sum-sum </property>
                    <value> 25 </value>
                </difference>
            </function>
        </fcs_function>

        <switch name="fcs/fly-by-wire/pitch/pitch-loop-gain-feedback-deadzone">
            <default value="0"/>
            <test logic="AND" value="fcs/fly-by-wire/pitch/pitch-loop-gain-feedback-deadzone-pos">
                fcs/fly-by-wire/pitch/pitch-loop-gain-sum-int-sum-sum gt  25
            </test>
            <test logic="AND" value="fcs/fly-by-wire/pitch/pitch-loop-gain-feedback-deadzone-neg">
                fcs/fly-by-wire/pitch/pitch-loop-gain-sum-int-sum-sum lt  -25
            </test>
        </switch>

        <pure_gain name="fcs/fly-by-wire/pitch/pitch-loop-gain-feedback-gain">
            <input>fcs/fly-by-wire/pitch/pitch-loop-gain-feedback-deadzone</input>
            <gain> 5 </gain>
        </pure_gain>

        <pure_gain name="fcs/fly-by-wire/pitch/alpha-feedback">
            <input>fcs/fly-by-wire/pitch/alpha-indicated-lagged</input>
            <gain> 0.5 </gain>
        </pure_gain>

        <summer name="fcs/fly-by-wire/pitch/pitch-loop-gain-final">
            <input> fcs/fly-by-wire/pitch/pitch-loop-gain-sum-int-sum </input>
            <input> fcs/fly-by-wire/pitch/alpha-feedback </input>
        </summer>

        <pure_gain name="velocities/q-aero-deg_sec">
            <input>velocities/q-aero-rad_sec</input>
            <gain> 57.29577951308233 </gain>
        </pure_gain>

        <washout_filter name="fcs/fly-by-wire/pitch/q-washout">
          <input> velocities/q-aero-rad_sec </input><!-- radians or degrees? -->
          <c1> 1 </c1>
        </washout_filter>

        <pure_gain name="fcs/fly-by-wire/pitch/q-gain-1">
            <input>fcs/fly-by-wire/pitch/q-washout</input>
            <gain> 0.7 </gain>
        </pure_gain>

        <scheduled_gain name="fcs/fly-by-wire/pitch/pitch-rate-gain">
            <input>fcs/fly-by-wire/pitch/q-gain-1</input>
            <table>
                <independentVar lookup="row">aero/qbar-psf</independentVar>
                <tableData>
                    0         1.00
                    114.8699  1.00
                    313.2815  0.30
                    417.7087  0.30
                </tableData>
            </table>
        </scheduled_gain>

        <fcs_function name="fcs/fly-by-wire/pitch/pitch-rate-gain-sum">
            <function>
                <sum>
                    <property> fcs/fly-by-wire/pitch/pitch-rate-gain </property>
                    <value> -15 </value> <!-- not sure if should be positive or negative 15, YF suggest -15 -->
                    <property> fcs/fly-by-wire/pitch/alpha-indicated-lagged </property>
                </sum>
            </function>
        </fcs_function>

        <pure_gain name="fcs/fly-by-wire/pitch/pitch-rate-gain-sum-gain">
            <input>fcs/fly-by-wire/pitch/pitch-rate-gain-sum</input>
            <gain> 0.322 </gain>
            <clipto>
                <min> 0 </min>
                <max>10000</max>
            </clipto>
        </pure_gain>

        <summer name="fcs/fly-by-wire/pitch/pitch-rate-gain-sum-gain-sum">
            <input> fcs/fly-by-wire/pitch/pitch-rate-gain-sum-gain </input>
            <input> fcs/fly-by-wire/pitch/pitch-rate-gain-2-sum </input>
        </summer>

        <fcs_function name="velocities/V-fps">
            <description>Page 42: Not used.</description>
            <function>
                <sqrt>
                    <sum>
                        <pow>
                            <property> velocities/u-fps </property>
                            <v>2</v>
                        </pow>
                        <pow>
                            <property> velocities/v-fps </property>
                            <v>2</v>
                        </pow>
                        <pow>
                            <property> velocities/w-fps </property>
                            <v>2</v>
                        </pow>
                    </sum>
                </sqrt>
            </function>
        </fcs_function>

        <fcs_function name="accelerations/a_n">
            <description>Page 43: Calc of G-force.</description>
            <function>
                <quotient>
                    <sum>
                        <product>
                            <property> velocities/q-rad_sec </property>
                            <property> velocities/u-fps </property>
                        </product>
                        <product>
                            <v>-1</v>
                            <property> velocities/p-rad_sec </property>
                            <property> velocities/v-fps </property>
                        </product>
                        <product>
                            <property> accelerations/gravity-ft_sec2 </property>
                            <cos>
                                <property> attitude/theta-rad </property>
                            </cos>
                            <cos>
                                <property> attitude/phi-rad </property>
                            </cos>
                        </product>
                        <product>
                            <v>-1</v>
                            <property> accelerations/wdot-ft_sec2 </property>
                        </product>
                    </sum>
                    <property> accelerations/gravity-ft_sec2 </property>
                </quotient>
            </function>
        </fcs_function>

        <fcs_function name="fcs/fly-by-wire/pitch/normal-1">
            <function>
                <difference>
                    <property> accelerations/a_n </property>
                    <value> 1 </value>
                </difference>
            </function>
        </fcs_function>

        <lag_filter name="fcs/fly-by-wire/pitch/normal-lagged">
            <input> fcs/fly-by-wire/pitch/normal-1 </input>
            <c1> 50 </c1>
        </lag_filter>

        <summer name="fcs/fly-by-wire/pitch/pitch-rate-gain-2-sum">
            <input> fcs/fly-by-wire/pitch/normal-lagged </input>
            <input> fcs/fly-by-wire/pitch/q-gain-2 </input>
        </summer>

        <pure_gain name="fcs/fly-by-wire/pitch/q-gain-2">
            <input>fcs/fly-by-wire/pitch/q-washout</input>
            <gain> 0.334 </gain>
        </pure_gain>

        <lead_lag_filter name="fcs/fly-by-wire/pitch/pitch-rate-lead">
          <input> fcs/fly-by-wire/pitch/pitch-rate-gain-sum-gain-sum </input>
          <c1> 3 </c1>
          <c2> 12 </c2>
          <c3> 1 </c3>
          <c4> 12 </c4>
        </lead_lag_filter>

        <summer name="fcs/fly-by-wire/pitch/tp-left-sum">
            <input> fcs/fly-by-wire/pitch/pitch-loop-gain-final </input>
            <!--<input> 0 </input> todo: input from roll system-->
        </summer>

        <summer name="fcs/fly-by-wire/pitch/bt-left-sum">
            <input> fcs/fly-by-wire/pitch/pitch-loop-gain-final </input>
            <!--<input> -0 </input>-->   <!-- todo: roll input -->
        </summer>

        <lag_filter name="fcs/fly-by-wire/pitch/tp-lag">
            <input> fcs/fly-by-wire/pitch/tp-left-sum </input>
            <c1> 20.2 </c1>
            <!-- defl. limit = 25, rate limit = 60 deg/s -->
        </lag_filter>

        <lag_filter name="fcs/fly-by-wire/pitch/bt-lag">
            <input> fcs/fly-by-wire/pitch/bt-left-sum </input>
            <c1> 20.2 </c1>
            <!-- defl. limit = 25, rate limit = 60 deg/s -->
        </lag_filter>

        <summer name="fcs/fly-by-wire/pitch/tp-right-sum">
            <input> fcs/fly-by-wire/pitch/tp-lag </input>
            <input> fcs/fly-by-wire/pitch/bt-lag </input>
        </summer>

        <summer name="fcs/fly-by-wire/pitch/bt-right-sum">
            <input> fcs/fly-by-wire/pitch/tp-lag </input>
            <input> -fcs/fly-by-wire/pitch/bt-lag </input>
        </summer>

        <pure_gain name="fcs/fly-by-wire/pitch/horz-tail-deflection">
            <input>fcs/fly-by-wire/pitch/tp-right-sum</input>
            <gain> 0.5 </gain>
        </pure_gain>

        <pure_gain name="fcs/fly-by-wire/pitch/horz-tail-diff-deflection">
            <input>fcs/fly-by-wire/pitch/bt-right-sum</input>
            <gain> 0.5 </gain>
        </pure_gain>

        <kinematic name="fcs/fly-by-wire/pitch/horz-tail-deflection-deg">
            <input>fcs/fly-by-wire/pitch/horz-tail-deflection</input>
            <traverse>
                <setting>
                    <position> -25.0 </position>
                    <time>      0.0 </time>
                </setting>
                <setting>
                    <position>  25.0 </position>
                    <time>      0.8333 </time>
                </setting>
            </traverse>
            <clipto>
                <min> -25 </min>
                <max>  25 </max>
            </clipto>
        </kinematic>

        <aerosurface_scale name="fcs/fly-by-wire/pitch/horz-tail-deflection-norm">
          <input>fcs/fly-by-wire/pitch/horz-tail-deflection-deg</input>
          <domain>
            <min>-25</min>
            <max>25</max>
          </domain>
          <range>
            <min>-1</min>
            <max>1</max>
          </range>
        </aerosurface_scale>

        <kinematic name="fcs/fly-by-wire/pitch/horz-tail-diff-deflection-deg">
            <input>fcs/fly-by-wire/pitch/horz-tail-diff-deflection</input>
            <traverse>
                <setting>
                    <position> -25.0 </position>
                    <time>      0.0 </time>
                </setting>
                <setting>
                    <position>  25.0 </position>
                    <time>      0.8333 </time>
                </setting>
            </traverse>
            <clipto>
                <min> -25 </min>
                <max>  25 </max>
            </clipto>
        </kinematic>

    </channel>

    <channel execrate="1" name="Roll">
    </channel>

    <channel execrate="1" name="Yaw">
    </channel>

    <channel execrate="1" name="Throttle">
    </channel>

<flight_control>